# Data Confidence Report — Phase 4A

## Purpose

This report documents the validation work performed in **Phase 4A** to establish
confidence that the RAID iOS pipeline is:

- End-to-end correct
- Deterministic
- Kernel-compliant

No UI, trend analysis, or insight layers are built on top of the system until
the guarantees documented here hold.

---

## Fixtures Used

### Session Fixture
- `tests/vectors/sessions/rapsodo_mlm2pro_mixed_club_sample.csv`

Properties:
- 15 valid shot rows
  - 6 × 7-iron
  - 9 × 5-iron
- 2 footer rows (`Average`, `Std. Dev.`) explicitly excluded

### Template Fixture
- JSON template fixture for **7-iron**
- Inserted via the production repository path
- Canonicalized and hashed using kernel rules

---

## Authoritative Semantics

### source_row_index

`source_row_index` is defined as:

> The **0-based index of ingested shot rows after filtering non-shot rows**
> (e.g., footer or summary rows).

It is **not** the raw CSV file line number.

For the session fixture:
- Valid range: `0..14`
- Uniqueness is enforced
- Ordering is stable and deterministic

---

## Tests Implemented

### 1) Fixture Ingest Integration
**CSV → persisted shots**

Asserts:
- Imported count equals expected shot rows
- No skipped or malformed rows
- `source_row_index` is unique and sequential
- Shots are fetchable by `session_id`
- Foreign key integrity holds (shots → session)

---

### 2) Classification + Aggregation Determinism
**Template → classify → aggregate**

Asserts:
- `A + B + C == totalShots`
- Repeated classification runs produce identical outputs
- Fresh database ingest produces the same A%
- No golden counts are locked in this phase

---

### 3) Immutability Guardrail
**Authoritative data cannot be mutated**

Asserts:
- UPDATE on shots table hard-fails
- DELETE on shots table hard-fails
- No silent mutation is possible

---

## What Is Explicitly Asserted

- End-to-end ingest correctness
- Deterministic classification and aggregation
- Stable row identity (`source_row_index`)
- Referential integrity
- Database-enforced immutability

---

## Phase 4A.2 — Golden Aggregate Parity (Now Asserted)

Phase 4A.2 locks a deterministic parity artifact generated by Python and consumed
by iOS tests.

Golden fixture:
- `tests/vectors/goldens/aggregate_parity_mixed_club_sample.json`

Generator:
- `tools/scripts/generate_aggregate_parity_golden.py`

iOS bundle copy (test resource):
- `ios/RAID/RAIDTests/aggregate_parity_mixed_club_sample.json`

Asserts now locked:
- Per-club `total_shots`
- Per-club metric `count` and `sum` for:
  - `carry`
  - `ball_speed`
  - `smash_factor`
  - `spin_rate`
  - `descent_angle`
- 7-iron template-scoped parity:
  - `template_hash` (fixture_a hash family)
  - `A/B/C` counts

Numeric policy (fixed):
- Sum comparison uses **fixed rounding to 6 decimals**
- Sums are serialized as fixed-decimal strings in the golden artifact

Scope note:
- 7i is classification parity scope for this vector (`fixture_a.json`)
- 5i is aggregate-only scope for this vector

---

## What Remains Deferred

- Additional parity vectors (for example, app seed template parity)
- Expanded club/template classification parity beyond the initial fixture_a scope

---

## Known Limitations

- Classification parity coverage is currently template-scoped to 7-iron (`fixture_a`)
- 5-iron classification parity is intentionally deferred in this first golden vector
- Additional parity fixtures (e.g., seed-template vector) are future work

---

## Exit Criteria

Phase 4A is considered complete when:
- All integration tests pass deterministically
- Immutability violations are explicitly rejected
- This report accurately reflects test coverage
- No UI or trend code depends on unvalidated assumptions

---

## Appendix: Observed Results (Non-Normative)

During Phase 4A validation runs, the following were observed for the
`rapsodo_mlm2pro_mixed_club_sample.csv` fixture:

- 7-iron shots: 6
- Classification: A=5, B=0, C=1 (A%=83.33%)
- Template hash: 96bf2f0d…

These values are **not contractual** and may change.
Exact numeric parity is locked only in Phase 4A.2 via golden fixtures.
